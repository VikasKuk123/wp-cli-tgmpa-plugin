#!/usr/bin/env bash
# Usage: print-full-usage | cat -s
#
# This script will print usage for all `wp tgmpa-plugin` commands which can be
# pasted into README.md.
#
# TODO: Figure out a way to update README.md automatically.

find_in_help() {
  if [[ "${2}" == *"${1}"* ]]; then
    awk "
      /^${1}/    { flag=1; next; }
      /^[A-Z]+/  { flag=0 }
      flag       { printf \"%s\\n\", \$0 }
    " <<< "${2}" | cat
  fi
}

description() {
  find_in_help DESCRIPTION "${1}" | sed 's/^[[:space:]]*//'
}

print_help_block() {
  text="$(find_in_help "${1}" "${2}" | sed -e 's/^ *//' -e '1d' )"
  if [[ "$text" ]]; then
    echo
    echo "**${1}**"
    echo
    echo '```'
    printf "%s\n" "$text"
    echo '```'
    echo
  fi
}

while read -r line; do
  printf "### %s\n" "$(awk '{ printf("%s %s %s", $1, $2, $3) }' <<< "${line}")"
  echo
  echo '```'
  printf "%s\n" "${line}"
  echo '```'
  echo

  cmd="$(awk '{ print $3 }' <<< "$line")"
  helptext="$(wp tgmpa-plugin $cmd --help)"
  description "${helptext}"

  print_help_block OPTIONS  "${helptext}"
  print_help_block EXAMPLES "${helptext}"

  echo
done < <(wp tgmpa-plugin | grep ": wp tgmpa-plugin" | sed "s/^.*: //")
